@inject IStringLocalizer<InvestorContractDialog> L
@using System.Text
@using InnFork.Application.Features.BaseActorModels.DTOs
@using System.Numerics
@using Innfork.Services
@using Innfork.Services.Localization

@inject ICurrentUserService _currentUserService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudForm @ref="_form" Class="pa-4">
        <MudPaper Elevation="2" Class="pa-4" Style="min-width: 1200px; max-width: 1800px;">
            <!-- Заголовок и информация об инвесторе -->
            <MudCard Elevation="0" Class="mb-4 pb-0" Style="background-color: var(--mud-palette-background-grey);">
                <MudCardHeader>

                </MudCardHeader>

                <!-- Карточка общей статистики -->
                <MudCardContent Class="pb-0">
                    <MudPaper Elevation="0" Class="pa-2">
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudPaper Elevation="0" Class="pa-4 d-flex flex-column align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" Size="Size.Large" Class="mb-2" />
                                    <MudText Typo="Typo.subtitle2" Color="Color.Default">@L["Общий баланс"]</MudText>
                                    <MudText Typo="Typo.h4" Color="Color.Info" Class="mt-1">@_totalBalance</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudPaper Elevation="0" Class="pa-4 d-flex flex-column align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Success" Size="Size.Large" Class="mb-2" />
                                    <MudText Typo="Typo.subtitle2" Color="Color.Default">@L["Свободный баланс"]</MudText>
                                    <MudText Typo="Typo.h4" Color="Color.Success" Class="mt-1">@_freeBalance</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudCardContent>
            </MudCard>

            <!-- Основные вкладки -->
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" AlwaysShowScrollButtons="true">


                <!-- ВКЛАДКА: ФИНАНСОВОЕ УПРАВЛЕНИЕ -->
                <MudTabPanel Icon="@Icons.Material.Filled.CreditCard" Text="@L["Финансовое управление"]">
                    <MudGrid>
                        <!-- Вывод средств -->
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="2" Class="h-100">
                                <MudCardHeader>
                                    <CardHeaderAvatar>
                                        <MudIcon Icon="@Icons.Material.Filled.MonetizationOn" Color="Color.Success" />
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@L["Вывод средств"]</MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudTooltip Text="@L["Обновить балансы"]">
                                            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Info" Size="Size.Small" OnClick="LoadInvestorBalances" />
                                        </MudTooltip>
                                    </CardHeaderActions>
                                </MudCardHeader>

                                <MudCardContent>
                                    <!-- Состояние баланса -->
                                    <MudPaper Elevation="0" Class="pa-3 mb-4" Style="background-color: var(--mud-palette-background-grey);">
                                        <MudGrid>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.subtitle2">@L["Общий баланс"]:</MudText>
                                                <MudText Typo="Typo.h5" Color="Color.Info">@_totalBalance</MudText>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.subtitle2">@L["Свободный баланс"]:</MudText>
                                                <MudText Typo="Typo.h5" Color="Color.Success">@_freeBalance</MudText>
                                            </MudItem>
                                        </MudGrid>
                                    </MudPaper>

                                    <!-- Форма вывода средств -->
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4">
                                        @L["Вы можете вывести только доступные свободные средства на основной счет InnFork"]
                                    </MudAlert>

                                    <MudNumericField T="decimal"
                                                     @bind-Value="_withdrawAmount"
                                                     Label="@L["Сумма для вывода"]"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Adornment="Adornment.Start"
                                                     AdornmentIcon="@Icons.Material.Filled.Money"
                                                     HelperText="@L["Укажите сумму для вывода (не больше свободного баланса)"]"
                                                     Class="mb-4"
                                                     FullWidth="true" />

                                    <MudTextField @bind-Value="_withdrawWallet"
                                                  Label="@L["Адрес кошелька (опционально)"]"
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.AccountBalanceWallet"
                                                  HelperText="@L["Оставьте пустым для использования основного кошелька"]"
                                                  Class="mb-4"
                                                  FullWidth="true" />

                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Secondary"
                                               OnClick="CheckCanWithdrawInvestment"
                                               StartIcon="@Icons.Material.Filled.HelpOutline"
                                               Class="mt-2"
                                               FullWidth="true">
                                        @L["Проверить возможность вывода"]
                                    </MudButton>

                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Warning"
                                               OnClick="WithdrawToInnFork"
                                               StartIcon="@Icons.Material.Filled.Send"
                                               FullWidth="true"
                                               Size="Size.Large"
                                               Disabled="@(_withdrawAmount <= 0)">
                                        @L["Вывести средства"]
                                    </MudButton>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>

                        <!-- Информационная панель -->
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="2" Class="h-100">
                                <MudCardHeader>
                                    <CardHeaderAvatar>
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" />
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@L["Информация о счете"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <MudCardContent>
                                    <MudList T="string">
                               
                                        <MudListItem Icon="@Icons.Material.Filled.ReceiptLong">
                                            <MudText>@L["Общее количество соглашений"]: <b>3</b></MudText>
                                        </MudListItem>
                                        <MudListItem Icon="@Icons.Material.Filled.Insights">
                                            <MudText>@L["Активные инвестиции"]: <b>@(_totalBalance - _freeBalance)</b></MudText>
                                        </MudListItem>
                                    </MudList>

                                    <MudDivider Class="my-4" />

                                    <MudText Typo="Typo.body2" Class="mb-2">@L["История операций"]</MudText>
                                    <MudPaper Elevation="0" Style="background-color: var(--mud-palette-background-grey); max-height: 240px; overflow-y: auto;" Class="pa-3">
                                        <MudTimeline TimelineAlign="TimelineAlign.Start" TimelinePosition="TimelinePosition.Left">
                                            <MudTimelineItem Color="Color.Success" Size="Size.Small">
                                                <MudText Typo="Typo.body2">@L["Инвестиция"] - 100.00</MudText>
                                                <MudText Typo="Typo.caption">@L["12.05.2023 10:30"]</MudText>
                                            </MudTimelineItem>
                                            <MudTimelineItem Color="Color.Warning" Size="Size.Small">
                                                <MudText Typo="Typo.body2">@L["Вывод средств"] - 25.00</MudText>
                                                <MudText Typo="Typo.caption">@L["14.05.2023 15:20"]</MudText>
                                            </MudTimelineItem>
                                            <MudTimelineItem Color="Color.Info" Size="Size.Small">
                                                <MudText Typo="Typo.body2">@L["Получение прибыли"] - 12.50</MudText>
                                                <MudText Typo="Typo.caption">@L["18.05.2023 09:15"]</MudText>
                                            </MudTimelineItem>
                                        </MudTimeline>
                                    </MudPaper>

                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               FullWidth="true"
                                               Class="mt-4"
                                               StartIcon="@Icons.Material.Filled.Refresh"
                                               OnClick="LoadInvestorBalances">
                                        @L["Обновить данные"]
                                    </MudButton>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- ВКЛАДКА: СОГЛАШЕНИЯ -->
                <MudTabPanel Icon="@Icons.Material.Filled.Handshake" Text="@L["Соглашения"]">
                    <MudGrid>
                        <!-- Создание соглашения -->
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="2" Class="h-100">
                                <MudCardHeader>
                                    <CardHeaderAvatar>
                                        <MudIcon Icon="@Icons.Material.Filled.AddCircle" Color="Color.Success" />
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@L["Создание соглашения"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <MudCardContent>

                                    <MudTextField @bind-Value="_manufacturerAddress"
                                                  Label="@L["Адрес производителя"]"
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Factory"
                                                  HelperText="@L["Введите адрес производителя для соглашения"]"
                                                  Class="mb-3"
                                                  FullWidth="true" />

                                    <MudNumericField T="decimal"
                                                     @bind-Value="_investmentAmount"
                                                     Label="@L["Сумма инвестиций"]"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Adornment="Adornment.Start"
                                                     AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                                     HelperText="@L["Укажите сумму инвестиций в соглашение"]"
                                                     Class="mb-3"
                                                     FullWidth="true" />

                                    <MudNumericField T="decimal"
                                                     @bind-Value="_repaymentAmount"
                                                     Label="@L["Сумма возврата"]"
                                                     Variant="Variant.Outlined"
                                                     Min="0"
                                                     Adornment="Adornment.Start"
                                                     AdornmentIcon="@Icons.Material.Filled.Payments"
                                                     HelperText="@L["Ожидаемая сумма возврата по соглашению"]"
                                                     Class="mb-3"
                                                     FullWidth="true" />

                                    <MudDatePicker @bind-Date="_dueDate"
                                                   Label="@L["Срок возврата"]"
                                                   Variant="Variant.Outlined"
                                                   Adornment="Adornment.Start"
                                                   AdornmentIcon="@Icons.Material.Filled.Event"
                                                   HelperText="@L["Укажите дату возврата инвестиций"]"
                                                   Class="mb-4" />

                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Success"
                                               OnClick="CreateAgreement"
                                               StartIcon="@Icons.Material.Filled.CreateNewFolder"
                                               FullWidth="true"
                                               Size="Size.Large">
                                        @L["Создать соглашение"]
                                    </MudButton>


                                </MudCardContent>
                            </MudCard>
                        </MudItem>

                        <!-- Управление соглашениями -->
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="2" Class="h-100">
                                <MudCardHeader>
                                    <CardHeaderAvatar>
                                        <MudIcon Icon="@Icons.Material.Filled.ManageAccounts" Color="Color.Primary" />
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@L["Управление соглашениями"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <MudCardContent>


                                    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pt-3" Color="Color.Primary">
                                        <MudTabPanel Text="@L["Действия с соглашениями"]" Icon="@Icons.Material.Filled.Edit">
                                            <MudTextField @bind-Value="_agreementId"
                                                          Label="@L["ID соглашения"]"
                                                          Variant="Variant.Outlined"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Description"
                                                          HelperText="@L["Введите идентификатор соглашения"]"
                                                          Class="mb-4"
                                                          FullWidth="true" />

                                            <MudNumericField T="decimal"
                                                             @bind-Value="_repayAmount"
                                                             Label="@L["Сумма возврата"]"
                                                             Variant="Variant.Outlined"
                                                             Min="0"
                                                             Adornment="Adornment.Start"
                                                             AdornmentIcon="@Icons.Material.Filled.Payments"
                                                             HelperText="@L["Сумма для возврата по соглашению"]"
                                                             Class="mb-4"
                                                             FullWidth="true" />

                                            <MudGrid>
                                                <MudItem xs="12" sm="4">
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Success"
                                                               OnClick="ConfirmAgreement"
                                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                                               FullWidth="true"
                                                               Class="mb-3">
                                                        @L["Подтвердить"]
                                                    </MudButton>
                                                </MudItem>
                                                <MudItem xs="12" sm="4">
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Info"
                                                               OnClick="CheckAgreementStatus"
                                                               StartIcon="@Icons.Material.Filled.Search"
                                                               FullWidth="true"
                                                               Class="mb-3">
                                                        @L["Проверить"]
                                                    </MudButton>
                                                </MudItem>
                                                <MudItem xs="12" sm="4">
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Warning"
                                                               OnClick="WithdrawProfit"
                                                               StartIcon="@Icons.Material.Filled.Savings"
                                                               FullWidth="true"
                                                               Class="mb-3">
                                                        @L["Вывод прибыли"]
                                                    </MudButton>
                                                </MudItem>
                                            </MudGrid>
                                        </MudTabPanel>



                                        <MudTabPanel Text="@L["предложения доли в прибыли"]" Icon="@Icons.Material.Filled.List">


                                            <MudItem xs="12">
                                                <MudCard Elevation="2" Class="h-100">
                                                    <MudCardHeader>
                                                        <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.PieChart" Color="Color.Tertiary" /></CardHeaderAvatar>
                                                        <CardHeaderContent><MudText Typo="Typo.h6">@L["Предложение доли прибыли"]</MudText></CardHeaderContent>
                                                    </MudCardHeader>

                                                    <MudCardContent>
                                                        <MudTextField @bind-Value="_manufacturerAddress"
                                                                      Label="@L["Адрес производителя"]"
                                                                      Variant="Variant.Outlined"
                                                                      Class="mb-3"
                                                                      FullWidth="true" />

                                                        <MudSlider @bind-Value="_profitSharePercentage"
                                                                   Min="1" Max="100" Step="1"
                                                                   Color="Color.Primary"
                                                                   Class="py-4">
                                                            @L["Процент доли в прибыли"]: @_profitSharePercentage%
                                                        </MudSlider>

                                                        <MudButton Variant="Variant.Filled"
                                                                   Color="Color.Primary"
                                                                   OnClick="ProposeProfitShare"
                                                                   StartIcon="@Icons.Material.Filled.Send"
                                                                   FullWidth="true">
                                                            @L["Предложить долю прибыли"]
                                                        </MudButton>
                                                    </MudCardContent>
                                                </MudCard>
                                            </MudItem>

                                        </MudTabPanel>


                                        <MudTabPanel Text="@L["Активные соглашения"]" Icon="@Icons.Material.Filled.List">
                                            <MudPaper Elevation="0" Style="max-height: 300px; overflow-y: auto;" Class="mb-4">
                                                <MudList T="string" Clickable="true">
                                                    <MudListItem Icon="@Icons.Material.Filled.Description" OnClick="@(() => SelectAgreement("agr-001"))">
                                                        <div class="d-flex flex-column">
                                                            <MudText Typo="Typo.body1">@L["Соглашение"]: agr-001</MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Success">@L["Активно"] • @L["Сумма"]: 100.00</MudText>
                                                        </div>
                                                    </MudListItem>
                                                    <MudListItem Icon="@Icons.Material.Filled.Description" OnClick="@(() => SelectAgreement("agr-002"))">
                                                        <div class="d-flex flex-column">
                                                            <MudText Typo="Typo.body1">@L["Соглашение"]: agr-002</MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Warning">@L["Ожидает подтверждения"] • @L["Сумма"]: 75.00</MudText>
                                                        </div>
                                                    </MudListItem>
                                                    <MudListItem Icon="@Icons.Material.Filled.Description" OnClick="@(() => SelectAgreement("agr-003"))">
                                                        <div class="d-flex flex-column">
                                                            <MudText Typo="Typo.body1">@L["Соглашение"]: agr-003</MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Info">@L["Завершено"] • @L["Сумма"]: 50.00</MudText>
                                                        </div>
                                                    </MudListItem>
                                                </MudList>
                                            </MudPaper>

                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.Refresh">
                                                @L["Обновить список соглашений"]
                                            </MudButton>
                                        </MudTabPanel>
                                    </MudTabs>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- ВКЛАДКА: ИНВЕСТИЦИИ -->
                <MudTabPanel Icon="@Icons.Material.Filled.TrendingUp" Text="@L["Инвестиции"]">
                    <MudGrid>
                        <!-- Инвестирование -->
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="2" Class="h-100">
                                <MudCardHeader>
                                    <CardHeaderAvatar>
                                        <MudIcon Icon="@Icons.Material.Filled.BusinessCenter" Color="Color.Tertiary" />
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@L["Управление инвестициями"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <MudCardContent>
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4">
                                        @L["Инвестируйте в проекты производителей и управляйте своими вложениями"]
                                    </MudAlert>

                                    <MudGrid>
                                        <MudItem xs="12">
                                            <MudTextField @bind-Value="_manufacturerAddress"
                                                          Label="@L["Адрес производителя"]"
                                                          Variant="Variant.Outlined"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Factory"
                                                          HelperText="@L["Введите адрес производителя для инвестирования"]"
                                                          Class="mb-4"
                                                          FullWidth="true" />
                                        </MudItem>

                                        <MudItem xs="12">
                                            <MudNumericField T="decimal"
                                                             @bind-Value="_amountToInvest"
                                                             Label="@L["Сумма инвестиций"]"
                                                             Variant="Variant.Outlined"
                                                             Min="0"
                                                             Adornment="Adornment.Start"
                                                             AdornmentIcon="@Icons.Material.Filled.Money"
                                                             HelperText="@L["Укажите сумму для инвестирования (не больше свободного баланса)"]"
                                                             Class="mb-4"
                                                             FullWidth="true" />
                                        </MudItem>

                                        <MudItem xs="12" md="6">
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Success"
                                                       OnClick="InvestToManufacturer"
                                                       StartIcon="@Icons.Material.Filled.ArrowUpward"
                                                       FullWidth="true"
                                                       Size="Size.Large"
                                                       Class="mb-3 py-2">
                                                @L["Инвестировать"]
                                            </MudButton>
                                        </MudItem>

                                        <MudItem xs="12" md="6">
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Warning"
                                                       OnClick="WithdrawInvestment"
                                                       StartIcon="@Icons.Material.Filled.ArrowDownward"
                                                       FullWidth="true"
                                                       Size="Size.Large"
                                                       Class="mb-3 py-2">
                                                @L["Отозвать инвестиции"]
                                            </MudButton>
                                        </MudItem>
                                    </MudGrid>

                                </MudCardContent>
                            </MudCard>
                        </MudItem>

                        <!-- Портфель инвестиций -->
                        <MudItem xs="12" md="6">
                            <MudCard Elevation="2" Class="h-100">
                                <MudCardHeader>
                                    <CardHeaderAvatar>
                                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Info" />
                                    </CardHeaderAvatar>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@L["Портфель текущих инвестиций"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>

                                <MudCardContent>

                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">

                                        <MudGrid>
                                   
                                            <MudStack Row="true">
                                                <MudText Typo="Typo.body2" Class="mr-2">@L["Общая сумма инвестиций"]:</MudText>
                                                <MudText Typo="Typo.h5" Color="Color.Primary">@L["137.50"]</MudText>
                                            </MudStack>

                                            <MudStack Row="true">
                                                <MudText Typo="Typo.body2" Class="mr-2">@L["Ожидаемая прибыль"]:</MudText>
                                                <MudText Typo="Typo.h5" Color="Color.Success">@L["+22.50"]</MudText>
                                            </MudStack>


                                        </MudGrid>

                                    </MudPaper>




                                    <MudPaper Elevation="0" Style="max-height: 350px; overflow-y: auto;" Class="mb-4">
                                        <MudList T="string">
                                            <MudListItem Icon="@Icons.Material.Filled.Business">
                                                <div class="d-flex justify-space-between" style="width: 100%">
                                                    <div>
                                                        <MudText Typo="Typo.body1">@L["Производитель"]: 0x471a2...</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Success">@L["Активно"]</MudText>
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.h6" Color="Color.Primary">@L["75.00"]</MudText>
                                                    </div>
                                                </div>
                                            </MudListItem>
                                            <MudDivider />
                                            <MudListItem Icon="@Icons.Material.Filled.Business">
                                                <div class="d-flex justify-space-between" style="width: 100%">
                                                    <div>
                                                        <MudText Typo="Typo.body1">@L["Производитель"]: 0x982b4...</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Warning">@L["В обработке"]</MudText>
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.h6" Color="Color.Primary">@L["42.50"]</MudText>
                                                    </div>
                                                </div>
                                            </MudListItem>
                                            <MudDivider />
                                            <MudListItem Icon="@Icons.Material.Filled.Business">
                                                <div class="d-flex justify-space-between" style="width: 100%">
                                                    <div>
                                                        <MudText Typo="Typo.body1">@L["Производитель"]: 0x763c1...</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Info">@L["Завершено"]</MudText>
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.h6" Color="Color.Primary">@L["20.00"]</MudText>
                                                    </div>
                                                </div>
                                            </MudListItem>
                                        </MudList>
                                    </MudPaper>

                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               FullWidth="true"
                                               Class="mt-4"
                                               StartIcon="@Icons.Material.Filled.Refresh">
                                        @L["Обновить статистику инвестиций"]
                                    </MudButton>

                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudPaper>
    </MudForm>
</MudContainer>





@* 
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <MudForm @ref="_form" Class="pa-4">
        <MudPaper Elevation="2" Class="pa-4" MinWidth="1200px">

            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3" AlwaysShowScrollButtons="true">


                <MudTabPanel Icon="@Icons.Material.Filled.Payments" Text="@L["Финансовое управление"]">
                    <MudPaper Elevation="4" Class="p-6 mb-4">

                        <MudNumericField T="decimal" @bind-Value="_withdrawAmount" Label="@L["Сумма вывода"]" />
                        <MudButton Color="Color.Warning" OnClick="WithdrawToInnFork">@L["Вывести в InnFork"]</MudButton>
                        <MudButton Variant="Variant.Outlined" OnClick="LoadInvestorBalances">@L["Загрузить балансы"]</MudButton>

                        <MudText Class="mt-2">@L["Общий баланс: @_totalBalance"]</MudText>
                        <MudText>@L["Свободный баланс: @_freeBalance"]</MudText>
                    </MudPaper>
                </MudTabPanel>
                <MudTabPanel Icon="@Icons.Material.Filled.Payments" Text="@L["соглашения"]">
                    <MudPaper Elevation="4" Class="p-6 mb-4">
                        <MudText Typo="Typo.h5">@L["Создание соглашения"]</MudText>
                        <MudTextField @bind-Value="_manufacturerAddress" Label="@L["Производитель"]" />
                        <MudNumericField T="decimal" @bind-Value="_investmentAmount" Label="@L["Сумма инвестиций"]" />
                        <MudNumericField T="decimal" @bind-Value="_repaymentAmount" Label="@L["Сумма возврата"]" />
                        <MudDatePicker @bind-Date="_dueDate" Label="@L["Срок возврата"]" />
                        <MudButton Color="Color.Success" OnClick="CreateAgreement">@L["Создать соглашение"]</MudButton>
                    </MudPaper>


                    <MudPaper Elevation="4" Class="p-6 mb-4">
                        <MudText Typo="Typo.h5">Соглашения / Профит</MudText>
                        <MudTextField @bind-Value="_agreementId" Label="@L["ID соглашения"]" />
                        <MudNumericField T="decimal" @bind-Value="_repayAmount" Label="@L["Сумма возврата"]" />
                        <MudButton OnClick="ConfirmAgreement">@L["Подтвердить соглашение"]</MudButton>
                        <MudButton OnClick="CheckAgreementStatus">@L["Проверить статус"]</MudButton>
                        <MudButton OnClick="WithdrawProfit">@L["Вывести прибыль"]</MudButton>
                    </MudPaper>
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.Payments" Text="@L["Инвестиции"]">
                    <MudPaper Elevation="4" Class="p-6">
                        <MudText Typo="Typo.h5">Инвестиции</MudText>
                        <MudTextField @bind-Value="_manufacturerAddress" Label="@L["Производитель"]" />
                        <MudNumericField T="decimal" @bind-Value="_amountToInvest" Label="@L["Сумма инвестиций"]" />
                        <MudButton OnClick="InvestToManufacturer">@L["Инвестировать"]</MudButton>
                        <MudButton OnClick="WithdrawInvestment">@L["Отозвать инвестиции"]</MudButton>
                    </MudPaper>
                </MudTabPanel>
            </MudTabs>
        </MudPaper>
    </MudForm>
</MudContainer>
  *@
@code {
    // Добавим метод для выбора соглашения из списка
    private void SelectAgreement(string id)
    {
        _agreementId = id;
    }

    private CancellationTokenSource _cts = new();

    protected override void OnInitialized()
    {
        _cts = new CancellationTokenSource();
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }

    private async Task LoadInvestorBalances()
    {
        try
        {
            _totalBalance = await QueryContract<decimal>("getTotalBalanceOfInvestorAccount", _investorAddress, _cts.Token);
            _freeBalance = await QueryContract<decimal>("getFreeBalanceOfInvestorAccount", _investorAddress, _cts.Token);
        }
        catch (OperationCanceledException ex)
        {
            Console.WriteLine("Операция отменена. " + ex.Message); // Игнорировать отменённые операции

            // Игнорировать отменённые операции
        }
    }


    [Parameter] public string InvestorAddress { get; set; } = "0x1234567890abcdef1234567890abcdef12345678"; // Замените на реальный адрес производителя}

    private MudForm _form;

    private async Task Save()
    {
        await _form.Validate();


        if (_form.IsValid)
        {
            // Логика сохранения
        }

    }
    private double _profitSharePercentage = 30;
    private bool _canWithdraw;

    private async Task ProposeProfitShare()
    {
        await CallContract("proposeProfitShare", InvestorAddress, _manufacturerAddress, Convert.ToDecimal(_profitSharePercentage));
    }

    private async Task CheckCanWithdrawInvestment()
    {
        _canWithdraw = await QueryContract<bool>("canWithdrawInvestment", InvestorAddress, _manufacturerAddress);
        // Отобразите результат пользователю, например, через Snackbar
    }


    private string _InvestorPublicKey;
    private string _withdrawWallet;

    private decimal _amountToWithdraw;

    private decimal _externalRating;
    private decimal _finalScore;

    private string _InvestorName;
    private string _investorAddress;
    private string _investorPublicKey;
    private string _manufacturerAddress;
    private string _agreementId;
    private decimal _amountToInvest;
    private decimal _withdrawAmount;
    private decimal _investmentAmount;
    private decimal _repaymentAmount;
    private decimal _repayAmount;
    private DateTime? _dueDate;

    private decimal _totalBalance;
    private decimal _freeBalance;

    private async Task CreateInvestor() => await CallContract("createInvestorAccount", _investorAddress, _investorPublicKey);

    private async Task WithdrawToInnFork() => await CallContract("moveFromInvestorBalanceToInnFork", _investorAddress, _withdrawAmount);
    private async Task InvestToManufacturer() => await CallContract("investAsInvestorToManufacturerCandidate", _investorAddress, _manufacturerAddress, _amountToInvest);
    private async Task WithdrawInvestment() => await CallContract("withdrawInvestment", _investorAddress, _manufacturerAddress, _amountToInvest);
    private async Task CreateAgreement() => await CallContract("createAgreement", _manufacturerAddress, _investmentAmount, new byte[32], _repaymentAmount, Convert.ToUInt64(((DateTime)_dueDate).Subtract(DateTime.UnixEpoch).TotalSeconds));

    private async Task ConfirmAgreement() => await CallContract("confirmAgreement", _agreementId);
    private async Task CheckAgreementStatus() => await CallContract("checkAgreementStatus", _agreementId);
    private async Task WithdrawProfit() => await CallContract("withdrawInvestorProfit", _investorAddress, _manufacturerAddress);

    private Task CallContract(string method, params object[] args) => Task.CompletedTask;
    private Task<T> QueryContract<T>(string method, params object[] args) => Task.FromResult(default(T));
   
    private async Task LoadAgreements()
    {
        // Здесь должна быть логика загрузки соглашений из контракта
        // Например, вызов метода контракта, который возвращает список соглашений инвестора
    }



    private async Task WithdrawFunds() => await CallContract("withdrawInvestor", InvestorAddress, _withdrawWallet, _amountToWithdraw);

    private async Task RepayAgreement() => await CallContract("processInvestorRepayment", _agreementId, _repaymentAmount);

    private async Task LoadBalances()
    {
        _totalBalance = await QueryContract<decimal>("getTotalBalanceOfInvestorAccount", InvestorAddress);
        _freeBalance = await QueryContract<decimal>("getFreeBalanceOfInvestorAccount", InvestorAddress);
    }

    private async Task GetRating()
    {
        _externalRating = await QueryContract<decimal>("getExternalRating", InvestorAddress);
        _finalScore = await QueryContract<decimal>("calculateInvestorFinalScore", InvestorAddress);
    }




    [Parameter] public string InvestorId { get; set; } = "InvestorId"; // Замените на реальный ID производителя}

    private InvestorInfo _Investor;

    private Task UpdateInvestor() => CallContract("updateInvestor", InvestorAddress, _InvestorName);



    private async Task LoadInvestor()
    {
        var result = await QueryContract<InvestorInfo>("getInvestor", InvestorAddress);
        _Investor = result;
    }

    // Примерные структуры и заглушки
    private record InvestorInfo(string Name, string[] ProductIds);
}



@* 
    // Управление аккаунтом инвестора
createInvestorAccount(UInt160 investorAddress, byte[] PublicKey)
getInvestorAccount(UInt160 investorAddress): InvestorAccount
updateInvestorAccount(UInt160 investorAddress, InvestorAccount account)

// Балансы инвестора
getTotalBalanceOfInvestorAccount(UInt160 investorAddress): decimal
getFreeBalanceOfInvestorAccount(UInt160 investorAddress): decimal
moveFromInvestorBalanceToInnFork(UInt160 investorAddress, decimal amount)

// Инвестиции и соглашения
investAsInvestorToInvestorCandidate(UInt160 investorAddress, UInt160 InvestorId, decimal amount)
withdrawInvestment(UInt160 investorAddress, UInt160 InvestorId, decimal amount)
InvestorAccount.createAgreement(UInt160 Investor, decimal investmentAmount, byte[] assetId, decimal repaymentAmount, ulong dueDate)
InvestorAccount.confirmAgreement(byte[] agreementId)
InvestorAccount.checkAgreementStatus(byte[] agreementId)
InvestorAccount.handleInvestmentPayment(Agreement agreement, byte[] agreementId, UInt160 from, decimal amount, UInt160 tokenHash)
InvestorAccount.trackAgreementParties(byte[] agreementId, UInt160 investor, UInt160 Investor)
InvestorAccount.handleRepayment(Agreement agreement, byte[] agreementId, UInt160 from, decimal amount, UInt160 tokenHash)

// Прибыль и соглашения
proposeProfitShare(UInt160 investor, UInt160 Investor, decimal profitSharePercentage)
withdrawInvestorProfit(UInt160 investor, UInt160 Investor)
canWithdrawInvestment(UInt160 investor, UInt160 Investor): bool


 *@